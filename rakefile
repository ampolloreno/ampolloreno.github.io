#This is taken from David Ensinger!
#http://davidensinger.com/2013/07/automating-jekyll-deployment-to-github-pages-with-rake/ 
resume_tex = "resume/resume.tex"
resume_aux = "resume/resume.aux"
resume_pdf = "resume/resume.pdf"
resume_path = "resume/"
output_flag = "-output-directory=" + resume_path + " "
xelatex = "xelatex " + output_flag
bibtex = "bibtex " + output_flag
pdflatex = "pdflatex" + output_flag

desc "Commit _site/"
task :commit do
  puts "\n## Building site."
  Dir.chdir "website"
  status = system("bundle exec jekyll build")
  Dir.chdir ".."
  puts status ? "Success" : "Failed"
  puts "\n## Staging modified files"
  status = system("git add -A")
  puts status ? "Success" : "Failed"
  puts "\n## Committing a site build at #{Time.now.utc}"
  message = "Build site at #{Time.now.utc}"
  status = system("git commit -m \"#{message}\"")
  puts status ? "Success" : "Failed"
  puts "\n## Pushing commits to remote"
  status = system("git push -ff source master:master")
  puts status ? "Success" : "Failed"
end

task :build_resume do
  puts "\n## Building resume, xelatex."
  status = system(xelatex + resume_tex)
  puts status ? "Success" : "Failed"
  puts "\n## Building resume, bibtex."
  status = system(bibtex + resume_aux)
  puts status ? "Success" : "Failed"
  puts "\n## Building resume, xelatex."
  status = system(xelatex + resume_tex)
  puts status ? "Success" : "Failed"
  status = system("cp " + resume_pdf + " website/")
  puts status ? "Success" : "Failed"
end

desc "Deploy _site/ to master branch"
task :deploy do
  puts "\n## Deleting site branch"
  status = system("git branch -D site")
  puts status ? "Success" : "Failed"
  puts "\n## Creating new production branch and switching to it"
  status = system("git checkout -b site")
  puts status ? "Success" : "Failed"
  puts "\n## Forcing the _site subdirectory to be project root"
  status = system("git filter-branch --subdirectory-filter website/_site/ -f")
  puts status ? "Success" : "Failed"
  puts "\n## Removing rakefile"
  status = system("rm rakefile")
  puts status ? "Success" : "Failed"
  status = system("git add -A")
  puts status ? "Success" : "Failed"
  status = system("git commit -m \"Removing rakefile\"")
  puts status ? "Success" : "Failed"
  puts "\n## Switching back to master branch"
  status = system("git checkout master")
  puts status ? "Success" : "Failed"
  puts "\n## Pushing all branches!"
  status = system("git push -ff source master:master")
  puts status ? "Success" : "Failed"
  status = system("git push -ff public site:master")
  puts status ? "Success" : "Failed"
end

desc "Build resume, and commit and deploy _site/"
task :commit_deploy => [:build_resume, :commit, :deploy] do
end
